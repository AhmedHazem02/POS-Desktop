<UserControl x:Class="POS.CustomControl.CustomerLedger_UserControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:validations="clr-namespace:POS.Validations"
             mc:Ignorable="d"
             MinWidth="900"
             MinHeight="700"
             FontFamily="Segoe UI"
             FlowDirection="RightToLeft"
             UseLayoutRounding="True"
             SnapsToDevicePixels="True">
    <UserControl.Resources>
        <validations:DoubleTextConverter x:Key="DoubleTextConverter" />
        <validations:BalanceToBrushConverter x:Key="BalanceToBrushConverter" />
        <validations:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />

        <Style x:Key="LedgerCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="16"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="#E5E7EB" BlurRadius="12" ShadowDepth="1" Opacity="0.35"/>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="FieldLabel" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="#475569"/>
            <Setter Property="Margin" Value="0,0,0,6"/>
        </Style>
    </UserControl.Resources>

    <Border FlowDirection="RightToLeft"
            Margin="10"
            CornerRadius="16"
            Background="#F8FAFC"
            BorderThickness="1"
            BorderBrush="#E2E8F0"
            Padding="16">
        <Grid>
            <Grid x:Name="ContentGrid" IsEnabled="{Binding IsNotBusy}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <StackPanel Grid.Row="0" Margin="4,0,4,12">
                    <TextBlock Text="كشف حساب العميل" FontSize="22" FontWeight="Bold" Foreground="#0F172A"/>
                    <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                        <TextBlock Text="الرصيد الحالي:" FontSize="13" Foreground="#64748B" Margin="0,0,6,0"/>
                        <TextBlock FontSize="16"
                                   FontWeight="Bold"
                                   Foreground="{Binding CurrentBalance, Converter={StaticResource BalanceToBrushConverter}}">
                            <Run Text="{Binding CurrentBalance, StringFormat={}{0:N2}}"/>
                            <Run Text=" جنيه"/>
                        </TextBlock>
                    </StackPanel>
                    <TextBlock Text="{Binding ErrorMessage}"
                               Foreground="#B91C1C"
                               FontSize="12"
                               Margin="0,6,0,0"
                               Visibility="{Binding HasError, Converter={StaticResource BoolToVisibilityConverter}}"/>
                </StackPanel>

                <!-- Filters -->
                <Border Grid.Row="1" Style="{StaticResource LedgerCard}" Margin="0,0,0,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Margin="0,0,12,0">
                            <TextBlock Text="العميل" Style="{StaticResource FieldLabel}"/>
                            <TextBox Text="{Binding CustomerSearchText, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     Height="32"
                                     Margin="0,0,0,6"/>
                            <ComboBox ItemsSource="{Binding Customers}"
                                      SelectedItem="{Binding SelectedCustomer}"
                                      DisplayMemberPath="DisplayName"
                                      IsEditable="False"
                                      Height="34"
                                      MaxDropDownHeight="320"
                                      ScrollViewer.CanContentScroll="True"
                                      VirtualizingPanel.IsVirtualizing="True"
                                      VirtualizingPanel.VirtualizationMode="Recycling" />
                            <TextBlock Text="جار تحميل العملاء..."
                                       FontSize="11"
                                       Foreground="#64748B"
                                       Margin="0,6,0,0"
                                       Visibility="{Binding IsCustomerLoading, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Margin="0,0,12,0">
                            <TextBlock Text="من تاريخ" Style="{StaticResource FieldLabel}"/>
                            <DatePicker SelectedDate="{Binding StartDate}" Height="34"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2" Margin="0,0,12,0">
                            <TextBlock Text="إلى تاريخ" Style="{StaticResource FieldLabel}"/>
                            <DatePicker SelectedDate="{Binding EndDate}" Height="34"/>
                        </StackPanel>

                        <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Bottom">
                            <Button Content="بحث"
                                    Margin="0,0,8,0"
                                    Padding="16,6"
                                    Style="{StaticResource CustomButtonStyle}"
                                    Background="#2563EB"
                                    Foreground="White"
                                    Command="{Binding RefreshCommand}"/>
                            <Button Content="مسح"
                                    Padding="16,6"
                                    Style="{StaticResource CustomButtonStyle}"
                                    Background="#E11D48"
                                    Foreground="White"
                                    Command="{Binding ClearFiltersCommand}"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Payment -->
                <Border Grid.Row="2" Style="{StaticResource LedgerCard}" Margin="0,0,0,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Margin="0,0,12,0">
                            <TextBlock Text="مبلغ التحصيل" Style="{StaticResource FieldLabel}"/>
                            <TextBox Text="{Binding PaymentAmount, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay, Converter={StaticResource DoubleTextConverter}}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     Height="34"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Margin="0,0,12,0">
                            <TextBlock Text="طريقة الدفع" Style="{StaticResource FieldLabel}"/>
                            <ComboBox ItemsSource="{Binding PaymentMethods}"
                                      SelectedItem="{Binding SelectedPaymentMethod}"
                                      Height="34"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2" Margin="0,0,12,0">
                            <TextBlock Text="مرجع الدفع" Style="{StaticResource FieldLabel}"/>
                            <TextBox Text="{Binding PaymentReference, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     Height="34"/>
                        </StackPanel>

                        <Button Grid.Column="3"
                                Content="تسجيل التحصيل"
                                Style="{StaticResource CustomButtonStyle}"
                                Background="#16A34A"
                                Foreground="White"
                                Padding="18,8"
                                Command="{Binding RecordPaymentCommand}"
                                Margin="0,18,0,0"/>
                    </Grid>
                </Border>

                <!-- Statement Table -->
                <Border Grid.Row="3" Style="{StaticResource LedgerCard}" Padding="0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <DataGrid Grid.Row="0"
                                  ItemsSource="{Binding LedgerEntries}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  SelectionMode="Single"
                                  HeadersVisibility="Column"
                                  RowHeight="34"
                                  FontSize="12"
                                  GridLinesVisibility="Horizontal"
                                  EnableRowVirtualization="True"
                                  EnableColumnVirtualization="True"
                                  VirtualizingPanel.IsVirtualizing="True"
                                  VirtualizingPanel.VirtualizationMode="Recycling"
                                  ScrollViewer.IsDeferredScrollingEnabled="True"
                                  ScrollViewer.CanContentScroll="True">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="التاريخ"
                                                    Binding="{Binding Date, StringFormat='{}{0:yyyy/MM/dd}'}"
                                                    Width="120"/>
                                <DataGridTextColumn Header="الوصف"
                                                    Binding="{Binding Description}"
                                                    Width="*"/>
                                <DataGridTextColumn Header="رقم المرجع"
                                                    Binding="{Binding ReferenceNumber}"
                                                    Width="140"/>
                                <DataGridTextColumn Header="مدين"
                                                    Binding="{Binding Debit, StringFormat={}{0:N2}}"
                                                    Width="120"/>
                                <DataGridTextColumn Header="دائن"
                                                    Binding="{Binding Credit, StringFormat={}{0:N2}}"
                                                    Width="120"/>
                                <DataGridTextColumn Header="الرصيد"
                                                    Binding="{Binding RunningBalance, StringFormat={}{0:N2}}"
                                                    Width="140">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Foreground"
                                                    Value="{Binding RunningBalance, Converter={StaticResource BalanceToBrushConverter}}"/>
                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="طريقة الدفع"
                                                    Binding="{Binding PaymentMethod}"
                                                    Width="130"/>
                            </DataGrid.Columns>
                        </DataGrid>

                        <Button Grid.Row="1"
                                Content="تحميل المزيد"
                                Style="{StaticResource CustomButtonStyle}"
                                Background="#0EA5E9"
                                Foreground="White"
                                Padding="16,6"
                                Margin="0,10,0,0"
                                HorizontalAlignment="Center"
                                Command="{Binding LoadNextPageCommand}"
                                Visibility="{Binding HasMore, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </Grid>
                </Border>
            </Grid>

            <!-- Busy overlay -->
            <Border Background="#66FFFFFF"
                    CornerRadius="12"
                    Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}"
                    Panel.ZIndex="10">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Margin="24">
                    <ProgressBar Width="180" Height="6" IsIndeterminate="True"/>
                    <TextBlock Text="{Binding BusyMessage}"
                               Margin="0,10,0,0"
                               FontSize="12"
                               Foreground="#0F172A"
                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>
        </Grid>
    </Border>
</UserControl>
