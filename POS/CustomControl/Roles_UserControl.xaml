<UserControl x:Class="POS.CustomControl.Roles_UserControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:validations="clr-namespace:POS.Validations"
             mc:Ignorable="d" 
             MinWidth="800" MinHeight="800">
    
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Assets/UltraModernStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <validations:IndexPlusOneConverter x:Key="IndexPlusOneConverter"/>
        </ResourceDictionary>
    </UserControl.Resources>

    <UserControl.Triggers>
        <EventTrigger RoutedEvent="Loaded">
            <BeginStoryboard Storyboard="{StaticResource FadeInAnimation}"/>
        </EventTrigger>
    </UserControl.Triggers>

    <Grid Background="{StaticResource BackgroundGradientBrush}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*"/> <!-- Roles List -->
            <ColumnDefinition Width="3*"/> <!-- Permissions -->
        </Grid.ColumnDefinitions>

        <!-- LEFT PANEL: Roles Management -->
        <Grid Grid.Column="0" Margin="20,20,10,20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Header -->
                <RowDefinition Height="Auto"/> <!-- Add Form -->
                <RowDefinition Height="*"/>    <!-- Roles List -->
            </Grid.RowDefinitions>

            <!-- Header -->
            <Border Grid.Row="0" CornerRadius="20" Padding="28,20" Margin="0,0,0,16">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                        <GradientStop Color="#7C3AED" Offset="0"/>
                        <GradientStop Color="#A855F7" Offset="1"/>
                    </LinearGradientBrush>
                </Border.Background>
                <Grid>
                    <StackPanel>
                        <TextBlock Text="إدارة الأدوار" FontSize="24" FontWeight="Bold" Foreground="White" FlowDirection="RightToLeft"/>
                        <TextBlock Text="تحديد الصلاحيات لكل دور" FontSize="12" Foreground="#E9D5FF" Margin="0,4,0,0" FlowDirection="RightToLeft"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Add Role Form -->
            <Border Grid.Row="1" Style="{StaticResource UltraModernCard}" Padding="20" Margin="0,0,0,16">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="إضافة دور جديد" FontSize="15" FontWeight="SemiBold" 
                               Foreground="{StaticResource Gray900Brush}" Margin="0,0,0,12" FlowDirection="RightToLeft"/>

                    <StackPanel Grid.Row="1">
                        <TextBlock Text="اسم الدور" FontSize="12" FontWeight="SemiBold" 
                                   Foreground="{StaticResource Gray700Brush}" Margin="0,0,0,6" FlowDirection="RightToLeft"/>
                        <TextBox Text="{Binding Name}" Style="{StaticResource UltraModernTextBox}"/>
                    </StackPanel>

                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,16,0,0">
                        <Button Content="إضافة" Style="{StaticResource UltraModernSuccessButton}"
                                Width="140" Command="{Binding AddCommand}"/>
                        
                        <Button Content="تعديل" Width="140" Margin="8,0,0,0" Command="{Binding EditCommand}">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource UltraModernWarningButton}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding CurrentState}" Value="Modify">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Roles DataGrid -->
            <Border Grid.Row="2" Style="{StaticResource UltraModernCard}" Padding="0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <Border Grid.Row="0" Background="{StaticResource Gray50}" Padding="16,12" BorderBrush="{StaticResource Gray200}" BorderThickness="0,0,0,1">
                        <TextBlock Text="قائمة الأدوار" FontSize="14" FontWeight="SemiBold" 
                                   Foreground="{StaticResource Gray900Brush}" FlowDirection="RightToLeft"/>
                    </Border>

                    <DataGrid Grid.Row="1" ItemsSource="{Binding Roles}" SelectedItem="{Binding SelectedItem}"
                              Style="{StaticResource UltraModernDataGrid}"
                              AutoGenerateColumns="False" IsReadOnly="True"
                              VirtualizingPanel.IsVirtualizing="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="#" Width="50" 
                                                Binding="{Binding RelativeSource={RelativeSource AncestorType=DataGridRow}, Converter={StaticResource IndexPlusOneConverter}}">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="TextAlignment" Value="Center"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                        <Setter Property="Foreground" Value="{StaticResource Gray500}"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>

                            <DataGridTemplateColumn Header="الدور" Width="*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Background="#F3E8FF" CornerRadius="8" Padding="12,8" Margin="4">
                                            <TextBlock Text="{Binding}" FontSize="13" FontWeight="SemiBold" 
                                                       Foreground="#7C3AED" FlowDirection="RightToLeft"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="إجراءات" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <Button Command="{Binding DataContext.EditItemCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Style="{StaticResource UltraModernGhostButton}"
                                                    Width="32" Height="32" Padding="0">
                                                <Path Fill="{StaticResource Primary600Brush}" Width="14" Height="14" Stretch="Uniform"
                                                      Data="M20.71 7.04C21.1 6.65 21.1 6 20.71 5.63L18.37 3.29C18 2.9 17.35 2.9 16.96 3.29L15.12 5.12L18.87 8.87M3 17.25V21H6.75L17.81 9.93L14.06 6.18L3 17.25Z"/>
                                            </Button>

                                            <Button Command="{Binding DataContext.DeleteItemCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}"
                                                    Style="{StaticResource UltraModernGhostButton}"
                                                    Width="32" Height="32" Padding="0" Margin="4,0,0,0">
                                                <Path Fill="{StaticResource Danger600Brush}" Width="14" Height="14" Stretch="Uniform"
                                                      Data="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                            </Button>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>
        </Grid>

        <!-- RIGHT PANEL: Permissions -->
        <Border Grid.Column="1" Style="{StaticResource UltraModernCard}" Margin="10,20,20,20" Padding="0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/> <!-- Header -->
                    <RowDefinition Height="Auto"/> <!-- Role Selector -->
                    <RowDefinition Height="*"/>    <!-- Permissions List -->
                    <RowDefinition Height="Auto"/> <!-- Save Button -->
                </Grid.RowDefinitions>

                <!-- Header -->
                <Border Grid.Row="0" Background="{StaticResource Gray50}" Padding="24,16" BorderBrush="{StaticResource Gray200}" BorderThickness="0,0,0,1">
                    <TextBlock Text="صلاحيات الدور" FontSize="18" FontWeight="Bold" 
                               Foreground="{StaticResource Gray900Brush}" FlowDirection="RightToLeft"/>
                </Border>

                <!-- Role Selector -->
                <Border Grid.Row="1" Padding="24,20" BorderBrush="{StaticResource Gray200}" BorderThickness="0,0,0,1">
                    <StackPanel>
                        <TextBlock Text="اختر الدور لتعديل صلاحياته" FontSize="13" FontWeight="SemiBold" 
                                   Foreground="{StaticResource Gray700Brush}" Margin="0,0,0,8" FlowDirection="RightToLeft"/>
                        <ComboBox ItemsSource="{Binding Roles}" SelectedItem="{Binding SelectedRole}" 
                                  Style="{StaticResource UltraModernComboBox}"/>
                    </StackPanel>
                </Border>

                <!-- Permissions List -->
                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Padding="24,16">
                    <ItemsControl ItemsSource="{Binding Permissions}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{StaticResource Gray50}" CornerRadius="12" Padding="16,12" Margin="0,0,0,8"
                                        BorderBrush="{StaticResource Gray200}" BorderThickness="1">
                                    <CheckBox Content="{Binding Name}" IsChecked="{Binding IsSelected}"
                                              FontSize="14" FontWeight="Medium" Foreground="{StaticResource Gray900Brush}"
                                              Checked="CheckBox_Checked" Unchecked="CheckBox_Unchecked"
                                              FlowDirection="RightToLeft">
                                        <CheckBox.Style>
                                            <Style TargetType="CheckBox">
                                                <Setter Property="Template">
                                                    <Setter.Value>
                                                        <ControlTemplate TargetType="CheckBox">
                                                            <StackPanel Orientation="Horizontal">
                                                                <Border x:Name="CheckBorder" Width="20" Height="20" 
                                                                        Background="White" BorderBrush="{StaticResource Gray300}" 
                                                                        BorderThickness="2" CornerRadius="6" Margin="0,0,12,0">
                                                                    <Path x:Name="CheckPath" Fill="White" Stretch="Uniform" 
                                                                          Width="12" Height="12" Visibility="Collapsed"
                                                                          Data="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/>
                                                                </Border>
                                                                <ContentPresenter VerticalAlignment="Center"/>
                                                            </StackPanel>
                                                            <ControlTemplate.Triggers>
                                                                <Trigger Property="IsChecked" Value="True">
                                                                    <Setter TargetName="CheckBorder" Property="Background">
                                                                        <Setter.Value>
                                                                            <LinearGradientBrush>
                                                                                <GradientStop Color="#7C3AED" Offset="0"/>
                                                                                <GradientStop Color="#A855F7" Offset="1"/>
                                                                            </LinearGradientBrush>
                                                                        </Setter.Value>
                                                                    </Setter>
                                                                    <Setter TargetName="CheckBorder" Property="BorderBrush" Value="#7C3AED"/>
                                                                    <Setter TargetName="CheckPath" Property="Visibility" Value="Visible"/>
                                                                </Trigger>
                                                                <Trigger Property="IsMouseOver" Value="True">
                                                                    <Setter TargetName="CheckBorder" Property="BorderBrush" Value="#7C3AED"/>
                                                                </Trigger>
                                                            </ControlTemplate.Triggers>
                                                        </ControlTemplate>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </CheckBox.Style>
                                    </CheckBox>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Save Button -->
                <Border Grid.Row="3" Padding="24,16" BorderBrush="{StaticResource Gray200}" BorderThickness="0,1,0,0">
                    <Button Content="حفظ التغييرات" Style="{StaticResource UltraModernSuccessButton}"
                            Width="200" HorizontalAlignment="Center" Command="{Binding SavePermissionsCommand}"/>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>
