<UserControl x:Class="POS.CustomControl.Users_UserControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:fa="http://schemas.fontawesome.io/icons/"
             xmlns:customcontrols="clr-namespace:POS.Components"
             xmlns:validations="clr-namespace:POS.Validations"
             mc:Ignorable="d" 
             MinWidth="800" MinHeight="800">
    
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Assets/UltraModernStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <validations:IndexPlusOneConverter x:Key="IndexPlusOneConverter"/>
            <validations:InitialsConverter x:Key="InitialsConverter"/>
            <validations:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <validations:StateToReadOnlyConverter x:Key="StateToReadOnlyConverter"/>
            <validations:StateToEnabledConverter x:Key="StateToEnabledConverter"/>
            <validations:StateToVisibilityConverter x:Key="StateToVisibilityConverter"/>
        </ResourceDictionary>
    </UserControl.Resources>

    <UserControl.Triggers>
        <EventTrigger RoutedEvent="Loaded">
            <BeginStoryboard Storyboard="{StaticResource FadeInAnimation}"/>
        </EventTrigger>
    </UserControl.Triggers>

    <Grid Background="{StaticResource BackgroundGradientBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- User Form -->
            <RowDefinition Height="Auto"/> <!-- Stats -->
            <RowDefinition Height="*"/>    <!-- DataGrid -->
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" CornerRadius="20" Margin="20,20,20,16" Padding="32,24">
            <Border.RenderTransform>
                <TranslateTransform x:Name="HeaderSlide"/>
            </Border.RenderTransform>
            <Border.Triggers>
                <EventTrigger RoutedEvent="Loaded">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation Storyboard.TargetName="HeaderSlide"
                                           Storyboard.TargetProperty="Y"
                                           From="-80" To="0" Duration="0:0:0.7">
                                <DoubleAnimation.EasingFunction>
                                    <BackEase EasingMode="EaseOut" Amplitude="0.4"/>
                                </DoubleAnimation.EasingFunction>
                            </DoubleAnimation>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Border.Triggers>
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#1E40AF" Offset="0"/>
                    <GradientStop Color="#3B82F6" Offset="0.5"/>
                    <GradientStop Color="#0EA5E9" Offset="1"/>
                </LinearGradientBrush>
            </Border.Background>
            <Grid>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Border Width="56" Height="56" CornerRadius="14" Background="#FFFFFF22" Padding="12" Margin="0,0,16,0">
                        <Path Fill="White" Stretch="Uniform"
                              Data="M12 4C13.0609 4 14.0783 4.42143 14.8284 5.17157C15.5786 5.92172 16 6.93913 16 8C16 9.06087 15.5786 10.0783 14.8284 10.8284C14.0783 11.5786 13.0609 12 12 12C10.9391 12 9.92172 11.5786 9.17157 10.8284C8.42143 10.0783 8 9.06087 8 8C8 6.93913 8.42143 5.92172 9.17157 5.17157C9.92172 4.42143 10.9391 4 12 4ZM12 14C16.42 14 20 15.79 20 18V20H4V18C4 15.79 7.58 14 12 14Z"/>
                    </Border>
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock Text="إدارة المستخدمين" FontSize="28" FontWeight="Bold" Foreground="White" FlowDirection="RightToLeft"/>
                        <TextBlock Text="إضافة وتعديل وإدارة حسابات المستخدمين" FontSize="13" Foreground="#E0E7FF" Margin="0,4,0,0" FlowDirection="RightToLeft"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>

        <!-- User Form Section -->
        <Border Grid.Row="1" Style="{StaticResource UltraModernCard}" Margin="20,0,20,16" Padding="28,24">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Form Title -->
                <TextBlock Grid.Row="0" Text="تفاصيل المستخدم" FontSize="18" FontWeight="Bold" 
                           Foreground="{StaticResource Gray900Brush}" Margin="0,0,0,20" FlowDirection="RightToLeft"/>

                <!-- Row 1: Username and Email -->
                <Grid Grid.Row="1" Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="16"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Text="اسم المستخدم" FontSize="13" FontWeight="SemiBold" 
                                   Foreground="{StaticResource Gray700Brush}" Margin="0,0,0,8" FlowDirection="RightToLeft"/>
                        <TextBox Text="{Binding UserName}" Style="{StaticResource UltraModernTextBox}"
                                 IsReadOnly="{Binding CurrentState, Converter={StaticResource StateToReadOnlyConverter}}"
                                 IsEnabled="{Binding CurrentState, Converter={StaticResource StateToEnabledConverter}}"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2">
                        <TextBlock Text="البريد الإلكتروني" FontSize="13" FontWeight="SemiBold" 
                                   Foreground="{StaticResource Gray700Brush}" Margin="0,0,0,8" FlowDirection="RightToLeft"/>
                        <TextBox Text="{Binding Email}" Style="{StaticResource UltraModernTextBox}"
                                 IsReadOnly="{Binding CurrentState, Converter={StaticResource StateToReadOnlyConverter}}"
                                 IsEnabled="{Binding CurrentState, Converter={StaticResource StateToEnabledConverter}}"/>
                    </StackPanel>
                </Grid>

                <!-- Row 2: First Name and Last Name -->
                <Grid Grid.Row="2" Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="16"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Text="الاسم الأول" FontSize="13" FontWeight="SemiBold" 
                                   Foreground="{StaticResource Gray700Brush}" Margin="0,0,0,8" FlowDirection="RightToLeft"/>
                        <TextBox Text="{Binding FirstName}" Style="{StaticResource UltraModernTextBox}"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2">
                        <TextBlock Text="الاسم الأخير" FontSize="13" FontWeight="SemiBold" 
                                   Foreground="{StaticResource Gray700Brush}" Margin="0,0,0,8" FlowDirection="RightToLeft"/>
                        <TextBox Text="{Binding LastName}" Style="{StaticResource UltraModernTextBox}"/>
                    </StackPanel>
                </Grid>

                <!-- Row 3: Phone and Password -->
                <Grid Grid.Row="3" Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="16"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Text="رقم الهاتف" FontSize="13" FontWeight="SemiBold" 
                                   Foreground="{StaticResource Gray700Brush}" Margin="0,0,0,8" FlowDirection="RightToLeft"/>
                        <TextBox Text="{Binding PhoneNumber}" Style="{StaticResource UltraModernTextBox}"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Visibility="{Binding CurrentState, Converter={StaticResource StateToVisibilityConverter}}">
                        <TextBlock Text="كلمة المرور" FontSize="13" FontWeight="SemiBold" 
                                   Foreground="{StaticResource Gray700Brush}" Margin="0,0,0,8" FlowDirection="RightToLeft"/>
                        <customcontrols:BindablePasswordBox Password="{Binding Password, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                           Height="44"/>
                    </StackPanel>
                </Grid>

                <!-- Row 4: Role Selection -->
                <Grid Grid.Row="4" Margin="0,0,0,24">
                    <StackPanel>
                        <TextBlock Text="تعيين الدور" FontSize="13" FontWeight="SemiBold" 
                                   Foreground="{StaticResource Gray700Brush}" Margin="0,0,0,8" FlowDirection="RightToLeft"/>
                        <ComboBox ItemsSource="{Binding Roles}" SelectedItem="{Binding SelectedRole}" 
                                  Style="{StaticResource UltraModernComboBox}" MaxWidth="400" HorizontalAlignment="Left"/>
                    </StackPanel>
                </Grid>

                <!-- Action Buttons -->
                <StackPanel Grid.Row="5" Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Content="إضافة مستخدم جديد" Style="{StaticResource UltraModernSuccessButton}"
                            Width="180" Command="{Binding AddCommand}"
                            Visibility="{Binding CurrentState, Converter={StaticResource StateToVisibilityConverter}}"/>
                    
                    <Button Content="تعديل البيانات" Width="180" Margin="8,0,0,0" Command="{Binding EditCommand}">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource UltraModernWarningButton}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentState}" Value="Modify">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                    
                    <Button Content="إلغاء" Width="140" Margin="8,0,0,0" Command="{Binding CancelCommand}">
                        <Button.Style>
                            <Style TargetType="Button" BasedOn="{StaticResource UltraModernDangerButton}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentState}" Value="Modify">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Users DataGrid -->
        <Border Grid.Row="3" Style="{StaticResource UltraModernCard}" Margin="20,0,20,20" Padding="0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Grid Header -->
                <Border Grid.Row="0" Background="{StaticResource Gray50}" Padding="24,16" BorderBrush="{StaticResource Gray200}" BorderThickness="0,0,0,1">
                    <Grid>
                        <TextBlock Text="قائمة المستخدمين" FontSize="16" FontWeight="SemiBold" 
                                   Foreground="{StaticResource Gray900Brush}" FlowDirection="RightToLeft" VerticalAlignment="Center"/>
                    </Grid>
                </Border>

                <!-- DataGrid -->
                <DataGrid Grid.Row="1" ItemsSource="{Binding ItemList}" SelectedItem="{Binding SelectedItem}"
                          Style="{StaticResource UltraModernDataGrid}"
                          AutoGenerateColumns="False" IsReadOnly="True"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.VirtualizationMode="Recycling"
                          EnableRowVirtualization="True">
                    <DataGrid.Columns>
                        <!-- Row Number -->
                        <DataGridTextColumn Header="#" Width="60" 
                                            Binding="{Binding RelativeSource={RelativeSource AncestorType=DataGridRow}, Converter={StaticResource IndexPlusOneConverter}}">
                            <DataGridTextColumn.HeaderStyle>
                                <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource UltraModernDataGridColumnHeader}">
                                    <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.HeaderStyle>
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="TextAlignment" Value="Center"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="Foreground" Value="{StaticResource Gray500}"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- User Info with Avatar -->
                        <DataGridTemplateColumn Header="المستخدم" Width="2.5*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Margin="0,8">
                                        <Border Width="40" Height="40" CornerRadius="10" Margin="0,0,12,0">
                                            <Border.Background>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                    <GradientStop Color="#1E40AF" Offset="0"/>
                                                    <GradientStop Color="#3B82F6" Offset="1"/>
                                                </LinearGradientBrush>
                                            </Border.Background>
                                            <TextBlock Text="{Binding FullName, Converter={StaticResource InitialsConverter}}"
                                                       FontSize="14" FontWeight="Bold" Foreground="White"
                                                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <StackPanel VerticalAlignment="Center">
                                            <TextBlock Text="{Binding FullName}" FontSize="14" FontWeight="SemiBold" 
                                                       Foreground="{StaticResource Gray900Brush}" FlowDirection="RightToLeft"/>
                                            <TextBlock Text="{Binding UserName}" FontSize="12" 
                                                       Foreground="{StaticResource Gray500}" Margin="0,2,0,0"/>
                                        </StackPanel>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- Email -->
                        <DataGridTextColumn Header="البريد الإلكتروني" Width="2*" Binding="{Binding Email}">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{StaticResource Gray700Brush}"/>
                                    <Setter Property="FontSize" Value="13"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Phone -->
                        <DataGridTextColumn Header="رقم الهاتف" Width="1.5*" Binding="{Binding PhoneNumber}">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{StaticResource Gray700Brush}"/>
                                    <Setter Property="FontSize" Value="13"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <!-- Role -->
                        <DataGridTemplateColumn Header="الدور" Width="1.5*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Border Background="#EEF2FF" CornerRadius="8" Padding="12,6" HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding DefaultRole}" FontSize="12" FontWeight="SemiBold" 
                                                   Foreground="#1E40AF" FlowDirection="RightToLeft"/>
                                    </Border>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!-- Actions -->
                        <DataGridTemplateColumn Header="الإجراءات" Width="140">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <Button Command="{Binding DataContext.EditItemCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource UltraModernGhostButton}"
                                                Width="36" Height="36" Padding="0" ToolTip="تعديل">
                                            <Path Fill="{StaticResource Primary600Brush}" Width="16" Height="16" Stretch="Uniform"
                                                  Data="M20.71 7.04C21.1 6.65 21.1 6 20.71 5.63L18.37 3.29C18 2.9 17.35 2.9 16.96 3.29L15.12 5.12L18.87 8.87M3 17.25V21H6.75L17.81 9.93L14.06 6.18L3 17.25Z"/>
                                        </Button>

                                        <Button Command="{Binding DataContext.DeleteItemCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource UltraModernGhostButton}"
                                                Width="36" Height="36" Padding="0" Margin="8,0,0,0" ToolTip="حذف">
                                            <Path Fill="{StaticResource Danger600Brush}" Width="16" Height="16" Stretch="Uniform"
                                                  Data="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                        </Button>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>
    </Grid>
</UserControl>
